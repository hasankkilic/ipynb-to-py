<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>IPYNB → PY Converter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem 3rem;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            text-align: center;
            margin-bottom: 2rem;
            color: #555;
        }
        
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }
        
        .dropzone {
            border: 2px dashed #888;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            margin-bottom: 1rem;
        }
        
        .dropzone.dragover {
            border-color: #2d7ff9;
            background: #f3f6ff;
        }
        
        #fileInput {
            display: none;
        }
        
        button {
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
        }
        
        button.primary {
            background: #2d7ff9;
            color: white;
        }
        
        button.secondary {
            background: #eee;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 0.75rem;
            font-size: 0.9rem;
            color: #555;
        }
        
        .status.error {
            color: #c0392b;
        }
        
        textarea {
            width: 100%;
            margin-top: 1rem;
            min-height: 250px;
            font-family: "Fira Code", Menlo, Monaco, Consolas, monospace;
            font-size: 0.9rem;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #ccc;
            resize: vertical;
            box-sizing: border-box;
        }
        
        .footer {
            margin-top: 2rem;
            font-size: 0.85rem;
            color: #777;
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>IPYNB → PY Converter</h1>
    <p class="subtitle">
        Convert your Jupyter Notebook (<code>.ipynb</code>) to a Python script (
        <code>.py</code>) in your browser. No upload, no server.
    </p>

    <div class="card">
        <div id="dropzone" class="dropzone">
            <strong>Click to choose a .ipynb file</strong><br> or drag & drop here
        </div>
        <input type="file" id="fileInput" accept=".ipynb,application/json">

        <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
            <button id="downloadBtn" class="primary" disabled>
                Download .py
            </button>
            <button id="clearBtn" class="secondary">
                Clear
            </button>
        </div>

        <div id="status" class="status">
            Waiting for a notebook file…
        </div>

        <textarea id="preview" placeholder="Converted Python code will appear here…" readonly></textarea>
    </div>

    <div class="footer">
        All conversion happens in your browser. Your notebook never leaves your device.
    </div>

    <script>
        const dropzone = document.getElementById("dropzone");
        const fileInput = document.getElementById("fileInput");
        const statusEl = document.getElementById("status");
        const previewEl = document.getElementById("preview");
        const downloadBtn = document.getElementById("downloadBtn");
        const clearBtn = document.getElementById("clearBtn");

        let lastFileName = "notebook";

        // --- UI helpers ------------------------------------------------------
        function setStatus(message, isError = false) {
            statusEl.textContent = message;
            statusEl.classList.toggle("error", isError);
        }

        function resetUI() {
            previewEl.value = "";
            downloadBtn.disabled = true;
            lastFileName = "notebook";
            setStatus("Waiting for a notebook file…");
        }

        clearBtn.addEventListener("click", () => resetUI());

        // --- File selection (click) ------------------------------------------
        dropzone.addEventListener("click", () => fileInput.click());

        fileInput.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        });

        // --- Drag & drop ------------------------------------------------------
        ["dragenter", "dragover"].forEach(evt =>
            dropzone.addEventListener(evt, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropzone.classList.add("dragover");
            })
        );

        ["dragleave", "drop"].forEach(evt =>
            dropzone.addEventListener(evt, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropzone.classList.remove("dragover");
            })
        );

        dropzone.addEventListener("drop", (e) => {
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });

        // --- Core: convert IPYNB JSON to Python string -----------------------
        function convertIpynbToPy(notebookJson) {
            if (!notebookJson || !Array.isArray(notebookJson.cells)) {
                throw new Error("This file doesn't look like a valid Jupyter notebook.");
            }

            const lines = [];

            lines.push("# Converted from Jupyter Notebook");
            if (notebookJson.metadata && notebookJson.metadata.kernelspec) {
                lines.push(
                    "# Kernel: " +
                    (notebookJson.metadata.kernelspec.display_name ||
                        notebookJson.metadata.kernelspec.name)
                );
            }
            lines.push("");

            notebookJson.cells.forEach((cell, index) => {
                const cellNum = index + 1;

                if (cell.cell_type === "markdown") {
                    lines.push(`# %% [markdown] cell ${cellNum}`);
                    (cell.source || []).forEach(line => {
                        // Ensure newline & prefix with comment
                        const clean = line.replace(/\r?\n$/, "");
                        lines.push("# " + clean);
                    });
                    lines.push("");
                } else if (cell.cell_type === "code") {
                    lines.push(`# %% code cell ${cellNum}`);
                    (cell.source || []).forEach(line => {
                        // Just copy code lines
                        lines.push(line.replace(/\r?\n$/, ""));
                    });
                    lines.push("");
                } else {
                    // Unknown cell type – keep as commented
                    lines.push(`# %% [unknown cell type: ${cell.cell_type}] ${cellNum}`);
                    (cell.source || []).forEach(line => {
                        const clean = line.replace(/\r?\n$/, "");
                        lines.push("# " + clean);
                    });
                    lines.push("");
                }
            });

            return lines.join("\n");
        }

        // --- File handling ----------------------------------------------------
        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith(".ipynb")) {
                setStatus("Please select a .ipynb file.", true);
                return;
            }

            lastFileName = file.name.replace(/\.ipynb$/i, "");
            setStatus("Reading file…");

            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const text = reader.result;
                    const notebook = JSON.parse(text);
                    const pyCode = convertIpynbToPy(notebook);
                    previewEl.value = pyCode;
                    downloadBtn.disabled = false;
                    setStatus("Conversion successful. You can review or download the .py file.");
                } catch (err) {
                    console.error(err);
                    setStatus("Failed to convert file: " + err.message, true);
                    previewEl.value = "";
                    downloadBtn.disabled = true;
                }
            };
            reader.onerror = () => {
                setStatus("Error reading file.", true);
            };
            reader.readAsText(file);
        }

        // --- Download button --------------------------------------------------
        downloadBtn.addEventListener("click", () => {
            const pyCode = previewEl.value;
            if (!pyCode) return;

            const blob = new Blob([pyCode], {
                type: "text/x-python"
            });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = lastFileName + ".py";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            URL.revokeObjectURL(url);
        });
    </script>
</body>

</html>